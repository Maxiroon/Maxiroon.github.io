<!DOCTYPE html>
<html>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Lexend:wght@100..900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="/CSS/style.css">
<script src="/JS/JSmain.js"></script>


<title>Blog - Maxiroon</title>
<link rel="icon" href="/media/favicon.ico">

<script src="/JS/template.js" defer></script>
<div id="nav"></div>

<head>
  <meta charset="UTF-8">
</head>
<body>
  <center>
  <h1 style="font-size: 60px;">Maxiroon's Blog</h1>
  <div style="display: flex; justify-content: center; gap: 10px; margin: 20px 0; flex-wrap: wrap;">
  <input 
    type="text" 
    id="blogSearch" 
    placeholder="Search..." 
    style="padding: 10px; width: 60%; max-width: 400px; border-radius: 10px; border: 2px solid #ffffff;"
  >
  <select id="blogSort" style="padding: 10px; border-radius: 10px; border: 2px solid #ffffff; color: white;">
    <option value="date-newest">Date: newest</option>
    <option value="date-oldest">Date: oldest</option>
    <option value="update-newest">Recently Updated</option>
    <hr>
    <option value="category-music">Category: Music</option>
    <option value="category-website">Category: Website</option>
    <option value="category-youtube">Category: YouTube</option>
  </select>
</div>
  <div class="cards-grid" id="blogGrid">
    <!-- Blog Entries go here -->
  </div></center>

<script>
async function loadPosts() {
  const grid = document.getElementById("blogGrid");

  function formatDate(dateStr) {
    if (!dateStr || dateStr === "Unknown") return "Unknown";
    let y, m, d;
    if (dateStr.includes(".")) {
      [y, m, d] = dateStr.split(".").map(Number);
      y = 2000 + (y % 100);
    } else {
      [y, m, d] = dateStr.split("-").map(Number);
      if (y < 100) y = 2000 + y;
    }
    const local = new Date(y, m - 1, d);
    return local.toLocaleDateString("en-US", {
      day: "2-digit",
      month: "short",
      year: "numeric"
    });
  }

  function escapeRegExp(str) {
    return str.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
  }

  function escapeHTML(str) {
    return str.replace(/[&<>"']/g, c => ({
      "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"
    }[c]));
  }

  function highlight(text, query) {
    if (!query) return escapeHTML(text);
    const re = new RegExp(escapeRegExp(query), "gi");
    let result = "";
    let last = 0;
    let m;
    while ((m = re.exec(text)) !== null) {
      result += escapeHTML(text.slice(last, m.index));
      result += "<span class='highlight'>" + escapeHTML(m[0]) + "</span>";
      last = m.index + m[0].length;
    }
    result += escapeHTML(text.slice(last));
    return result;
  }

  const res = await fetch("/blog/posts.json");
  let posts = await res.json();

  posts.sort((a, b) => {
    const [aY, aM, aD] = a.replace(".html","").split(".").map(Number);
    const [bY, bM, bD] = b.replace(".html","").split(".").map(Number);
    const dateA = new Date(2000 + aY, aM - 1, aD);
    const dateB = new Date(2000 + bY, bM - 1, bD);
    return dateB - dateA; // newest first
  });

  const cards = [];

  for (const file of posts) {
    try {
      const htmlRes = await fetch(`/blog/${file}`);
      const html = await htmlRes.text();
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, "text/html");

      const title = doc.querySelector("h1")?.textContent.trim() || "Untitled";
      const postDateRaw = doc.querySelector("meta[name='post-date']")?.content || file.split(".").slice(0,3).join("-");
      const updateDateRaw = doc.querySelector("meta[name='update-date']")?.content || postDateRaw;
      const coverImage = doc.querySelector("meta[name='cover-image']")?.content || "";
      const category = doc.querySelector("meta[name='category']")?.content?.trim().toLowerCase() || "uncategorized";

      const postDate = formatDate(postDateRaw);
      const updateDate = formatDate(updateDateRaw);

      let firstParagraph = doc.querySelector("p")?.textContent || "";
      let preview = firstParagraph.split(/\s+/).slice(0, 20).join(" ");
      if (firstParagraph.split(/\s+/).length > 20) preview += "...";

      const card = document.createElement("div");
      card.classList.add("cards-card");
      card.setAttribute("data-title", title.toLowerCase());
      card.setAttribute("data-preview", preview.toLowerCase());
      card.setAttribute("data-title-raw", title);
      card.setAttribute("data-preview-raw", preview);
      card.setAttribute("data-post-date", postDateRaw);
      card.setAttribute("data-update-date", updateDateRaw);
      card.setAttribute("data-category", category);

      const imageHTML = coverImage
        ? `<img class="cards-image" src="${coverImage}" alt="${escapeHTML(title)}">`
        : `<div class="cards-image">NO IMAGE</div>`;

      card.innerHTML = `
        ${imageHTML}
        <h1>${escapeHTML(title)}</h1>
        <h3>Published: ${escapeHTML(postDate)} | Updated: ${escapeHTML(updateDate)}</h3>
        <hr>
        <p>${escapeHTML(preview)}</p>
        <a href="/blog/${file}">Read More</a>
      `;

      grid.appendChild(card);
      cards.push(card);
    } catch (err) {
      console.error("Error loading post:", file, err);
    }
  }

  // Event listeners for search + sort
  document.getElementById("blogSort").addEventListener("change", applyFilters);
  document.getElementById("blogSearch").addEventListener("input", applyFilters);

  function applyFilters() {
    const query = document.getElementById("blogSearch").value.toLowerCase();
    const sortValue = document.getElementById("blogSort").value;

    let filteredCards = [...cards];

    // Search filter
    if (query) {
      filteredCards = filteredCards.filter(card => {
        const inTitle = card.getAttribute("data-title").includes(query);
        const inPreview = card.getAttribute("data-preview").includes(query);
        return inTitle || inPreview;
      });
    }

    // Sort / category filter
    if (sortValue === "date-newest" || sortValue === "date-oldest") {
      filteredCards.sort((a, b) => {
        const dateA = new Date(a.getAttribute("data-post-date"));
        const dateB = new Date(b.getAttribute("data-post-date"));
        return sortValue === "date-newest" ? dateB - dateA : dateA - dateB;
      });
    } else if (sortValue === "update-newest" || sortValue === "update-oldest") {
      filteredCards.sort((a, b) => {
        const dateA = new Date(a.getAttribute("data-update-date"));
        const dateB = new Date(b.getAttribute("data-update-date"));
        return sortValue === "update-newest" ? dateB - dateA : dateA - dateB;
      });
    } else if (sortValue.startsWith("category-")) {
      const category = sortValue.split("-")[1];
      filteredCards = filteredCards.filter(
        card => card.getAttribute("data-category") === category
      );
    }

    // Re-render grid
    grid.innerHTML = "";
    if (filteredCards.length > 0) {
      filteredCards.forEach(card => {
        const titleRaw = card.getAttribute("data-title-raw");
        const previewRaw = card.getAttribute("data-preview-raw");
        const postDate = formatDate(card.getAttribute("data-post-date"));
        const updateDate = formatDate(card.getAttribute("data-update-date"));
        const imgEl = card.querySelector(".cards-image")?.outerHTML || "";

        card.innerHTML = `
          ${imgEl}
          <h1>${highlight(titleRaw, query)}</h1>
          <h3>Published: ${escapeHTML(postDate)} | Updated: ${escapeHTML(updateDate)}</h3>
          <hr>
          <p>${highlight(previewRaw, query)}</p>
          <a href="${card.querySelector("a")?.getAttribute("href") || "#"}">Read More</a>
        `;
        grid.appendChild(card);
      });
    } else {
      grid.innerHTML = `
        <div class="no-results">
          <img src="/media/404.png" alt="No results" style="width:500x; display:block; margin:20px auto; border: 0px;">
          <h1 style="text-align:center;">No posts found!</h1>
        </div>
      `;
    }
  }

  // Initial run
  applyFilters();
}

loadPosts();
</script>



</body>

<footer>
    <br>
    <center>
        <div id="footer"></div>
    </center>
    <br>
</footer>

</html>
